'use strict';const {PrismaClient}=require("@prisma/client"),prisma=new PrismaClient;
async function migrateToProjects(){console.log("\ud83d\ude80 Starting migration to project-based structure...");try{console.log("\ud83d\udccb Step 1: Fetching existing users...");const c=await prisma.user.findMany({include:{events:!0,persons:!0,life_events:!0,literature:!0,event_types:!0,importHistory:!0,dataUncertainty:!0,duplicateMatches:!0}});console.log(`Found ${c.length} users to migrate`);console.log("\ud83d\udccb Step 2: Creating default projects for users...");const f=c.map(async a=>{var b=
await prisma.project.findFirst({where:{owner_id:a.id,name:"Default Project"}});if(b)return console.log(`User ${a.email} already has a default project`),b;b=await prisma.project.create({data:{name:"Default Project",description:"Default project for existing data",owner_id:a.id,updated_at:new Date}});console.log(`Created default project for user ${a.email}`);return b}),e=await Promise.all(f);console.log(`Created/verified ${e.length} default projects`);console.log("\ud83d\udccb Step 3: Migrating existing data to projects...");
for(const a of c){const b=e.find(d=>d.owner_id===a.id);b?(console.log(`Migrating data for user ${a.email}...`),0<a.events.length&&(await prisma.events.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}}),console.log(`  - Migrated ${a.events.length} events`)),0<a.persons.length&&(await prisma.persons.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}}),console.log(`  - Migrated ${a.persons.length} persons`)),0<a.life_events.length&&(await prisma.life_events.updateMany({where:{userId:a.id,
project_id:null},data:{project_id:b.id}}),console.log(`  - Migrated ${a.life_events.length} life events`)),0<a.literature.length&&(await prisma.literature.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}}),console.log(`  - Migrated ${a.literature.length} literature entries`)),0<a.event_types.length&&(await prisma.event_types.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}}),console.log(`  - Migrated ${a.event_types.length} event types`)),0<a.importHistory.length&&
(await prisma.import_history.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}}),console.log(`  - Migrated ${a.importHistory.length} import history entries`)),0<a.dataUncertainty.length&&(await prisma.data_uncertainty.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}}),console.log(`  - Migrated ${a.dataUncertainty.length} data uncertainty entries`)),0<a.duplicateMatches.length&&(await prisma.duplicate_matches.updateMany({where:{userId:a.id,project_id:null},
data:{project_id:b.id}}),console.log(`  - Migrated ${a.duplicateMatches.length} duplicate match entries`))):console.log(`\u26a0\ufe0f  No project found for user ${a.email}, skipping...`)}console.log("\ud83d\udccb Step 4: Adding users to their default projects...");const g=c.map(async a=>{const b=e.find(d=>d.owner_id===a.id);b&&(await prisma.userProject.findFirst({where:{user_id:a.id,project_id:b.id}})?console.log(`User ${a.email} is already a member of their default project`):(await prisma.userProject.create({data:{user_id:a.id,
project_id:b.id,role:"owner"}}),console.log(`Added user ${a.email} as owner to their default project`)))});await Promise.all(g);console.log("\ud83d\udccb Step 5: Verifying migration...");const n=await Promise.all(c.map(async a=>{const b=e.find(h=>h.owner_id===a.id);if(!b)return{user:a.email,status:"no_project"};const [d,k,l,m]=await Promise.all([prisma.events.count({where:{userId:a.id,project_id:b.id}}),prisma.persons.count({where:{userId:a.id,project_id:b.id}}),prisma.life_events.count({where:{userId:a.id,
project_id:b.id}}),prisma.literature.count({where:{userId:a.id,project_id:b.id}})]);return{user:a.email,project:b.name,events:d,persons:k,lifeEvents:l,literature:m}}));console.log("\n\ud83d\udcca Migration Summary:");n.forEach(a=>{"no_project"===a.status?console.log(`\u274c ${a.user}: No project found`):console.log(`\u2705 ${a.user}: ${a.events} events, ${a.persons} persons, ${a.lifeEvents} life events, ${a.literature} literature`)});console.log("\n\ud83c\udf89 Migration completed successfully!")}catch(c){throw console.error("\u274c Migration failed:",
c),c;}finally{await prisma.$disconnect()}}require.main===module&&migrateToProjects().then(()=>{console.log("\u2705 Migration script completed");process.exit(0)}).catch(c=>{console.error("\u274c Migration script failed:",c);process.exit(1)});module.exports={migrateToProjects};