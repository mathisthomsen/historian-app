'use strict';const {PrismaClient}=require("@prisma/client"),prisma=new PrismaClient;
async function createBackup(){console.log("\ud83d\udcbe Creating backup of current data...");const e={users:await prisma.user.findMany({include:{events:!0,persons:!0,life_events:!0,literature:!0,event_types:!0,importHistory:!0,dataUncertainty:!0,duplicateMatches:!0}}),timestamp:(new Date).toISOString()},d=require("fs"),f=`backup-${Date.now()}.json`;d.writeFileSync(f,JSON.stringify(e,null,2));console.log(`\u2705 Backup saved to ${f}`);return e}
async function migrateToProjectsProduction(e=!1){console.log("\ud83d\ude80 Starting PRODUCTION migration to project-based structure...");console.log(`Mode: ${e?"DRY RUN":"LIVE MIGRATION"}`);try{const g=await createBackup();if(e){console.log("\ud83d\udd0d DRY RUN: Simulating migration...");for(const a of g.users)console.log(`Would migrate user ${a.email}:`),console.log(`  - ${a.events.length} events`),console.log(`  - ${a.persons.length} persons`),console.log(`  - ${a.life_events.length} life events`),
console.log(`  - ${a.literature.length} literature entries`),console.log(`  - ${a.event_types.length} event types`),console.log(`  - ${a.importHistory.length} import history entries`),console.log(`  - ${a.dataUncertainty.length} data uncertainty entries`),console.log(`  - ${a.duplicateMatches.length} duplicate match entries`);console.log("\n\u2705 DRY RUN completed - no changes made")}else{console.log("\ud83d\udccb Step 1: Fetching existing users...");var d=await prisma.user.findMany({include:{events:!0,
persons:!0,life_events:!0,literature:!0,event_types:!0,importHistory:!0,dataUncertainty:!0,duplicateMatches:!0}});console.log(`Found ${d.length} users to migrate`);console.log("\ud83d\udccb Step 2: Creating default projects for users...");var f=d.map(async a=>{var b=await prisma.project.findFirst({where:{owner_id:a.id,name:"Default Project"}});if(b)return console.log(`User ${a.email} already has a default project`),b;b=await prisma.project.create({data:{name:"Default Project",description:"Default project for existing data",
owner_id:a.id,updated_at:new Date}});console.log(`Created default project for user ${a.email}`);return b}),h=await Promise.all(f);console.log(`Created/verified ${h.length} default projects`);console.log("\ud83d\udccb Step 3: Migrating existing data to projects...");for(const a of d){const b=h.find(c=>c.owner_id===a.id);if(b){console.log(`Migrating data for user ${a.email}...`);if(0<a.events.length){const c=await prisma.events.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}});
console.log(`  - Migrated ${c.count} events`)}if(0<a.persons.length){const c=await prisma.persons.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}});console.log(`  - Migrated ${c.count} persons`)}if(0<a.life_events.length){const c=await prisma.life_events.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}});console.log(`  - Migrated ${c.count} life events`)}if(0<a.literature.length){const c=await prisma.literature.updateMany({where:{userId:a.id,project_id:null},
data:{project_id:b.id}});console.log(`  - Migrated ${c.count} literature entries`)}if(0<a.event_types.length){const c=await prisma.event_types.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}});console.log(`  - Migrated ${c.count} event types`)}if(0<a.importHistory.length){const c=await prisma.import_history.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}});console.log(`  - Migrated ${c.count} import history entries`)}if(0<a.dataUncertainty.length){const c=
await prisma.data_uncertainty.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}});console.log(`  - Migrated ${c.count} data uncertainty entries`)}if(0<a.duplicateMatches.length){const c=await prisma.duplicate_matches.updateMany({where:{userId:a.id,project_id:null},data:{project_id:b.id}});console.log(`  - Migrated ${c.count} duplicate match entries`)}}else console.log(`\u26a0\ufe0f  No project found for user ${a.email}, skipping...`)}console.log("\ud83d\udccb Step 4: Adding users to their default projects...");
var k=d.map(async a=>{const b=h.find(c=>c.owner_id===a.id);b&&(await prisma.userProject.findFirst({where:{user_id:a.id,project_id:b.id}})?console.log(`User ${a.email} is already a member of their default project`):(await prisma.userProject.create({data:{user_id:a.id,project_id:b.id,role:"owner"}}),console.log(`Added user ${a.email} as owner to their default project`)))});await Promise.all(k);console.log("\ud83d\udccb Step 5: Verifying migration...");var q=await Promise.all(d.map(async a=>{const b=
h.find(l=>l.owner_id===a.id);if(!b)return{user:a.email,status:"no_project"};const [c,m,n,p]=await Promise.all([prisma.events.count({where:{userId:a.id,project_id:b.id}}),prisma.persons.count({where:{userId:a.id,project_id:b.id}}),prisma.life_events.count({where:{userId:a.id,project_id:b.id}}),prisma.literature.count({where:{userId:a.id,project_id:b.id}})]);return{user:a.email,project:b.name,events:c,persons:m,lifeEvents:n,literature:p}}));console.log("\n\ud83d\udcca Migration Summary:");q.forEach(a=>
{"no_project"===a.status?console.log(`\u274c ${a.user}: No project found`):console.log(`\u2705 ${a.user}: ${a.events} events, ${a.persons} persons, ${a.lifeEvents} life events, ${a.literature} literature`)});console.log("\n\ud83c\udf89 PRODUCTION migration completed successfully!");console.log("\u26a0\ufe0f  Backup file created - keep it safe!")}}catch(g){throw console.error("\u274c Migration failed:",g),g;}finally{await prisma.$disconnect()}}
if(require.main===module){const e=process.argv.includes("--dry-run");migrateToProjectsProduction(e).then(()=>{console.log("\u2705 Migration script completed");process.exit(0)}).catch(d=>{console.error("\u274c Migration script failed:",d);process.exit(1)})}module.exports={migrateToProjectsProduction,createBackup};